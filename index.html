<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tomar foto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      overflow: auto;
    }
    #container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      width: 100vw;
    }
    video, canvas, img {
      max-width: 90vw;
      max-height: 60vh;
      border-radius: 12px;
      box-shadow: 0 0 20px #000a;
      background: #222;
    }
#controls {
  margin-top: 2em;
  display: flex;
  flex-direction: column;
  gap: 1em;
  align-items: stretch;
}
    button {
      padding: 1em 2em;
      font-size: 1.2em;
      border-radius: 8px;
      border: none;
      background: #0a84ff;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:active {
      background: #005bb5;
    }
    #take.cancel {
      background: #d32f2f;
    }
    #take.cancel:active {
      background: #b71c1c;
    }
    #status {
      margin-top: 1em;
      font-size: 1.1em;
      min-height: 2em;
    }
  </style>
</head>
<body>
  <div id="container">
    <video id="video" autoplay playsinline></video>
    <div id="resolution" style="margin: 0.5em 0; font-size: 1em; color: #aaa;"></div>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="photo" style="display:none;" alt="Foto tomada" />

    <div id="controls">
      <button id="take">Tomar foto</button>
      <button id="send" style="display:none;" disabled>Enviar</button>
      <button id="switch">Cambiar cámara</button>
      <input id="zoom" type="range" min="1" max="1" step="0.1" value="1" style="display:none;">
      <button id="rotate" style="display:none;">Rotar foto</button>
    </div>
    <div id="status"></div>
  </div>
  <details style="margin-top:2em; color:#ccc; font-size:0.95em;">
    <summary>Detalles técnicos / errores</summary>
    <pre id="errorlog" style="white-space:pre-wrap; word-break:break-all;"></pre>
  </details>
  <script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const photo = document.getElementById('photo');
const takeBtn = document.getElementById('take');
const sendBtn = document.getElementById('send');
const status = document.getElementById('status');

let stream = null;
let imageBlob = null;
let facingMode = 'user'; // 'user' = selfie, 'environment' = trasera
let zoomSlider = null;
let videoTrack = null;
let rotation = 0; // grados de rotación de la foto
const rotateBtn = document.getElementById('rotate');
let capturedImage = null; // Imagen capturada para rotar

// Acceder a la cámara
async function startCamera() {
  try {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } } });
    video.srcObject = stream;
    video.style.display = 'block';
    photo.style.display = 'none';
    // Mostrar resolución actual
    setTimeout(() => {
      const resDiv = document.getElementById('resolution');
      const vw = video.videoWidth;
      const vh = video.videoHeight;
      if (vw && vh) {
        resDiv.textContent = `Resolución: ${vw}×${vh}`;
      } else {
        resDiv.textContent = '';
      }
    }, 500);

    // Zoom
    zoomSlider = document.getElementById('zoom');
    videoTrack = stream.getVideoTracks()[0];
    const capabilities = videoTrack.getCapabilities();
    rotateBtn.style.display = 'none'; // Ocultar rotar al iniciar cámara
    if (capabilities.zoom) {
      zoomSlider.min = capabilities.zoom.min;
      zoomSlider.max = capabilities.zoom.max;
      zoomSlider.step = capabilities.zoom.step || 0.1;
      zoomSlider.value = videoTrack.getSettings().zoom || capabilities.zoom.min;
      zoomSlider.style.display = 'block';
      zoomSlider.oninput = async () => {
        try {
          await videoTrack.applyConstraints({ advanced: [{ zoom: parseFloat(zoomSlider.value) }] });
        } catch (e) {
          status.textContent = 'No se pudo aplicar el zoom: ' + e;
          status.style.color = 'red';
          document.getElementById('errorlog').textContent += '\n[ZOOM] ' + (e && e.stack ? e.stack : e);
        }
      };
    } else {
      zoomSlider.style.display = 'none';
    }
  } catch (err) {
    status.textContent = 'No se pudo acceder a la cámara: ' + err;
    status.style.color = 'red';
    document.getElementById('errorlog').textContent += '\n[CAMBIO CAMARA] ' + (err && err.stack ? err.stack : err);
    document.getElementById('errorlog').textContent += '\n[CAMARA] ' + (err && err.stack ? err.stack : err);
  }
}

// Tomar foto o cancelar
let mode = 'take';
function drawRotatedPhoto(img, rot) {
  // img: objeto Image
  // rot en grados: 0, 90, 180, 270
  const w = img.width;
  const h = img.height;
  const ctx = canvas.getContext('2d');
  if (rot % 180 === 0) {
    canvas.width = w;
    canvas.height = h;
  } else {
    canvas.width = h;
    canvas.height = w;
  }
  ctx.save();
  if (rot === 90) {
    ctx.translate(canvas.width, 0);
    ctx.rotate(Math.PI / 2);
  } else if (rot === 180) {
    ctx.translate(canvas.width, canvas.height);
    ctx.rotate(Math.PI);
  } else if (rot === 270) {
    ctx.translate(0, canvas.height);
    ctx.rotate(3 * Math.PI / 2);
  }
  ctx.drawImage(img, 0, 0, w, h);
  ctx.restore();
}

takeBtn.onclick = () => {
  if (mode === 'take') {
    const w = video.videoWidth;
    const h = video.videoHeight;
    rotation = 0;
    // Capturar imagen del video
    canvas.width = w;
    canvas.height = h;
    canvas.getContext('2d').drawImage(video, 0, 0, w, h);
    // Guardar imagen capturada
    capturedImage = new Image();
    capturedImage.width = w;
    capturedImage.height = h;
    capturedImage.src = canvas.toDataURL('image/jpeg', 0.95);
    capturedImage.onload = () => {
      drawRotatedPhoto(capturedImage, rotation);
      canvas.toBlob(blob => {
        imageBlob = blob;
        photo.src = URL.createObjectURL(blob);
        photo.style.display = 'block';
        video.style.display = 'none';
        sendBtn.disabled = false;
        sendBtn.style.display = 'inline-block';
        takeBtn.textContent = 'Cancelar';
        takeBtn.classList.add('cancel');
        mode = 'cancel';
        status.textContent = 'Foto lista para enviar';
        status.style.color = '#fff';
        rotateBtn.style.display = 'inline-block';
        document.getElementById('zoom').style.display = 'none';
      }, 'image/jpeg', 0.95);
    };


rotateBtn.onclick = () => {
  if (mode !== 'cancel' || !capturedImage) return;
   rotation = (rotation + 270) % 360;
  drawRotatedPhoto(capturedImage, rotation);
  canvas.toBlob(blob => {
    imageBlob = blob;
    photo.src = URL.createObjectURL(blob);
  }, 'image/jpeg', 0.95);
};
    } else if (mode === 'cancel') {
    // Cancelar y volver a la cámara
    imageBlob = null;
    photo.style.display = 'none';
    video.style.display = 'block';
    sendBtn.disabled = true;
    sendBtn.style.display = 'none';
    takeBtn.textContent = 'Tomar foto';
    takeBtn.classList.remove('cancel');
    mode = 'take';
    status.textContent = 'Puedes tomar otra foto';
    status.style.color = '#fff';
    rotateBtn.style.display = 'none';
    // Mostrar el slider solo si la cámara lo soporta
    if (videoTrack && videoTrack.getCapabilities().zoom) {
      zoomSlider.style.display = 'block';
    } else {
      zoomSlider.style.display = 'none';
    }
  }
};


// Enviar foto al servidor
sendBtn.onclick = async () => {
  if (!imageBlob) return;
  status.textContent = 'Enviando...';
  status.style.color = '#0a84ff';
  sendBtn.disabled = true;
  sendBtn.textContent = 'Enviando...';
  const formData = new FormData();
  formData.append('foto', imageBlob, 'foto.jpg');
  try {
    let url = window.location.origin + '/';
    const res = await fetch(url, {
      method: 'POST',
      body: formData
    });
    if (res.ok) {
      status.textContent = '¡Foto enviada con éxito!';
      status.style.color = '#0f0';
      sendBtn.textContent = '¡Enviado!';
      // Reset UI para tomar otra foto
      photo.style.display = 'none';
      video.style.display = 'block';
      sendBtn.textContent = 'Enviar';
      sendBtn.style.display = 'none';
      takeBtn.textContent = 'Tomar foto';
      takeBtn.classList.remove('cancel');
      mode = 'take';
      takeBtn.disabled = false;
      sendBtn.disabled = true;
       status.textContent = 'Puedes tomar otra foto';
       status.style.color = '#fff';
       // Mostrar el slider solo si la cámara lo soporta
       if (videoTrack && videoTrack.getCapabilities().zoom) {
         zoomSlider.style.display = 'block';
       } else {
         zoomSlider.style.display = 'none';
       }
     } else {
      status.textContent = 'Error al enviar la foto';
      status.style.color = 'red';
      sendBtn.textContent = 'Enviar';
      sendBtn.disabled = false;
      document.getElementById('errorlog').textContent += '\n[ENVIO] Error al enviar la foto';
    }
  } catch (err) {
    status.textContent = 'Error de red: ' + err;
    status.style.color = 'red';
    sendBtn.textContent = 'Enviar';
    sendBtn.disabled = false;
    document.getElementById('errorlog').textContent += '\n[RED] ' + (err && err.stack ? err.stack : err);
  }
};

const switchBtn = document.getElementById('switch');
switchBtn.onclick = () => {
  facingMode = facingMode === 'user' ? 'environment' : 'user';
  // Limpiar UI y estado
  if (photo) photo.style.display = 'none';
  if (canvas) canvas.style.display = 'none';
  sendBtn.disabled = true;
  sendBtn.style.display = 'none';
  takeBtn.textContent = 'Tomar foto';
  takeBtn.classList.remove('cancel');
  takeBtn.disabled = false;
  mode = 'take';
  status.textContent = 'Puedes tomar otra foto';
  status.style.color = '#fff';
    rotateBtn.style.display = 'none';
    capturedImage = null;
    imageBlob = null;
    startCamera();
};

startCamera();
</script>
</body>
</html>
